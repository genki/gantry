#!/bin/sh
GANTRY_START=$@
SRC=$GANTRY_TEMPLATE
DST=$GANTRY_TARGET
ADDR=`echo $GANTRY_PORT | awk -F'//' '{print $2}' | awk -F: '{print $1" "$2}'`

conf(){
  NLINES=`wc -l $SRC | awk '{print $1}'`
  cat $SRC | awk -v nlines=$NLINES -v arg=$1 '
    BEGIN{printf "%s %s\n", nlines, arg}
    {print $0}
  ' | nc $ADDR | awk -v DST=$DST '
    NR==1{print}
    NR>=2{print > DST}
  '
}
DIGEST=`conf fetch`
echo "new $DST (digest=$DIGEST)"
while :; do
  NEW_DIGEST=`conf watch`
  if [ "$DIGEST" != "$NEW_DIGEST" ]; then
    $GANTRY_CHECK && $GANTRY_RELOAD
    DIGEST=$NEW_DIGEST
    echo "update $DST (digest=$DIGEST)"
  fi
done &
$GANTRY_CHECK && exec $GANTRY_START
